@namespace NodeService.WebServer.UI.Pages.Nodes.List
@page "/nodes"
@using NodeService.Infrastructure.DataModels

@inject ApiService ApiService;
@inject NotificationService _notice
@inject NavigationManager NavigationManager
@inject IMessageService _message

<GridContent>
    <Drawer Closable="true" Width="320" Visible="nodeInfoDrawerVisible" Title='("修改节点信息")' OnClose="_=>CloseModifyNodeInfoDrawer()">
        <Template style="height:90%">
            @if (this._editingNodeInfoModel == null)
            {
                <Row>
                    <AntDesign.Col Span="24">
                        <Alert>请选择一个节点</Alert>
                    </AntDesign.Col>
                </Row>
                <br />
                <Row>
                    <AntDesign.Col Span="6">
                        <Button Type="default">取消</Button>
                    </AntDesign.Col>
                    <AntDesign.Col Span="6">
                        <Button Type="primary" OnClick="CloseModifyNodeInfoDrawer">提交</Button>
                    </AntDesign.Col>
                </Row>
            }
            else
            {
                @if (this._modifyErrorMsg != null)
                {
                    <Row>
                        <AntDesign.Col Span="24">
                            <Alert Message="@_modifyErrorMsg" Type="@AlertType.Error" />
                        </AntDesign.Col>
                    </Row>
                }

                <Row Gutter="24">
                    <AntDesign.Col Span="24">
                        <Text>测试分类</Text>
                        <Input @bind-Value="@_editingNodeInfoModel.TestInfo" Placeholder="请输入测试分类" TValue="string"></Input>
                    </AntDesign.Col>
                    <AntDesign.Col Span="24">
                        <Text>实验室区域</Text>
                        <Input @bind-Value="@_editingNodeInfoModel.LabArea" Placeholder="请输入实验室区域" TValue="string" />
                    </AntDesign.Col>
                    <AntDesign.Col Span="24">
                        <Text>实验室名称</Text>
                        <Input @bind-Value="@_editingNodeInfoModel.LabName" Placeholder="请输入实验室名称" TValue="string" />
                    </AntDesign.Col>
                </Row>
                <br />
                <AntDesign.Col Span="24">
                    <Text>用途</Text>
                    <Input @bind-Value="@_editingNodeInfoModel.Usages" Placeholder="请输入用途" TValue="string" />
                </AntDesign.Col>
                <Row>
                    <AntDesign.Col Span="24">
                        <Text>备注</Text>
                        <TextArea @bind-Value="@_editingNodeInfoModel.Remarks" Placeholder="请输入备注"></TextArea>
                    </AntDesign.Col>
                </Row>
                <br />
                <Row>
                    <AntDesign.Col Span="6">
                        <Button Type="default" OnClick="CloseModifyNodeInfoDrawer">取消</Button>
                    </AntDesign.Col>
                    <AntDesign.Col Span="6">
                        <Button Type="primary" OnClick="SubmitNodeInfoAsync">提交</Button>
                    </AntDesign.Col>
                </Row>
            }

        </Template>
    </Drawer>
        <Modal Width="800"
           Title="节点配置"
           Visible="@_editFormVisible"
           ConfirmLoading="@_editFormConfirmLoading"
           OnOk="@HandleEditFormOk" 
           OnCancel="@HandleEditFormCancel">
        <Form Model="@_nodeSettings" Size="@AntSizeLDSType.Default"
              LabelColSpan="4" 
              Layout="@FormLayout.Horizontal"
              WrapperColSpan="20"
              OnFinish="OnEditFormFinish"
              OnFinishFailed="OnEditFormFinishFailed"
              @ref="@_editForm">
            <FormItem Label="IP地址区域映射">
                <Space>
                    <SpaceItem>
                        <Button Shape="@ButtonShape.Circle" Icon="@IconType.Outline.Plus" OnClick="AddIpAddressMapping" Type="primary">
                        </Button>
                    </SpaceItem>
                    <SpaceItem>
                        <Button Shape="@ButtonShape.Circle" Danger Icon="@IconType.Outline.Delete" OnClick="RemoveSelectedIpAddressMapping" Type="primary">
                        </Button>
                    </SpaceItem>
                </Space>
      
     
                <StringEntryTable ValueTitle="Ip地址" NameTitle="区域" IsTagHidden="false" IsTagEditable="true" TagTitle="代号" SelectedItems="@_selectedIpAddressMappings" DataSource="@context.IpAddressMappings" />
            </FormItem>
            <FormItem Label="进程用途映射">

                <Button Shape="@ButtonShape.Circle" Icon="@IconType.Outline.Plus" OnClick="AddProcessUsageMapping" Type="primary">
                </Button>
                <Button Shape="@ButtonShape.Circle" Danger Icon="@IconType.Outline.Delete" OnClick="RemoveSelectedProcessUsageMapping" Type="primary">
                    
                </Button>
                <StringEntryTable ValueTitle="用途" NameTitle="进程名称" SelectedItems="@_selectedProcessUsagesMappings" DataSource="@context.ProcessUsagesMapping" />
            </FormItem>

        </Form>
    </Modal>
    <GridRow Gutter="(8, 0)">
        <GridCol Span="24">
             <Table Loading="@_loading" 
                 @ref="_table" 
                 Size="TableSize.Small" 
                 EnableVirtualization="true" 
                 OnChange="OnTableChange" 
                 TItem="NodeInfoModel" 
                 DataSource="@_dataSource" 
                 OnRowClick="OnRowClick">
                 <TitleTemplate>
                     <GridRow>
                         <GridCol Span="4">
                             <Title Level="3">节点列表</Title>
                         </GridCol>
                         <GridCol Span="20" Offset="0" >
                            <Space>
                                <SpaceItem>
                                    <Button Shape="@ButtonShape.Circle" Type="@ButtonType.Primary" Icon="@IconType.Outline.Reload" OnClick="QueryNodeListAsync"></Button>
                                </SpaceItem>
                                <SpaceItem>
                                    <Button Shape="@ButtonShape.Circle" Type="@ButtonType.Primary" Icon="@IconType.Outline.Setting" OnClick="ShowNodeSettingsModalAsync"></Button>

                                </SpaceItem>
                                <SpaceItem>
                                    <Select DataSource="@_nodeSettings.IpAddressMappings"
                                            @bind-value="@_selectedAreaTag"
                                            TItem="StringEntry"
                                            Style="width:200px"
                                            TItemValue="string"
                                            DefaultActiveFirstOption
                                            LabelName="@nameof(StringEntry.Name)"
                                            ValueName="@nameof(StringEntry.Tag)" />
                                </SpaceItem>
                                <SpaceItem>
                                    <RadioGroup @bind-Value="_nodeState" Size="middle">
                                        <Radio RadioButton Value="@(NodeState.All)">全部</Radio>
                                        <Radio RadioButton Value="@(NodeState.Online)">在线</Radio>
                                        <Radio RadioButton Value="@(NodeState.Offline)">离线</Radio>
                                    </RadioGroup>
                                </SpaceItem>
                                <SpaceItem>
                                    <Search Style="width:200px" Placeholder="搜索节点" @bind-Value="@_keywords" OnSearch="()=>_table?.ReloadData()" />
                                </SpaceItem>
                            </Space>
                         </GridCol>
                     </GridRow>
                 </TitleTemplate>
                 <ColumnDefinitions>
                     <PropertyColumn Title="厂区" Filters="areaNameFilters" OnFilter="((name,value)=>OnFilterFactoryName(value,name))" Sortable="true" Filterable="true" Property="c=>c.Profile.FactoryName">
                         @switch (context.Profile.FactoryName)
                        {
                            case "BL":
                                <Text>博罗</Text>
                            break;
                            case "GM":
                                <Text>光明</Text>
                                break;
                            default:
                                <Text>未知</Text>
                                break;
                        }
                     </PropertyColumn>
                     <PropertyColumn Title="节点名称" Sortable="true" Property="c=>c.Name">
                        @switch (context.Status)
                        {
                            case NodeStatus.Online:
                                <Badge Style="margin-right:10px" Status="@BadgeStatus.Processing"></Badge>
                                break;
                            case NodeStatus.Offline:
                                <Badge Style="margin-right:10px" Status="@BadgeStatus.Warning"></Badge>
                                break;
                            case NodeStatus.NotConfigured:
                                <Badge Style="margin-right:10px" Status="@BadgeStatus.Error"></Badge>
                                break;
                        }
                         <NavLink href="@("/nodes/"+context.Id)">@context.Name</NavLink>
                        </PropertyColumn>
                    <PropertyColumn Title="最后在线时间" Sortable="true" Format="@NodePropertyModel.DateTimeFormatString" Property="c=>c.Profile.ServerUpdateTimeUtc"></PropertyColumn><PropertyColumn Title="测试分类" Sortable="true" Property="c=>c.Profile.TestInfo"></PropertyColumn>
                    <PropertyColumn Title="实验室区域" Sortable="true" Property="c=>c.Profile.LabArea"></PropertyColumn>
                    <PropertyColumn Title="实验室名称" Sortable="true" Property="c=>c.Profile.LabName"></PropertyColumn>

                    <PropertyColumn Title="用途" Sortable="true" Property="c=>c.Profile.Usages"><Tag>@(string.IsNullOrEmpty(context.Profile.Usages) ? "（空）" : context.Profile.Usages)</Tag></PropertyColumn>
                    <PropertyColumn Title="备注" Sortable="true" Property="c=>c.Profile.Remarks"><Tag>@(string.IsNullOrEmpty(context.Profile.Remarks) ? "（空）" : context.Profile.Remarks)</Tag></PropertyColumn>
                    <PropertyColumn Title="IP地址" Sortable="true" Property="c=>c.Profile.IpAddress"><Tag>@context.Profile.IpAddress</Tag></PropertyColumn>
                        <ActionColumn Fixed="right" Title="操作">
                            <Space Size=@("middle")>
                            <SpaceItem>
                                    <Button Shape="@ButtonShape.Circle" Type="@ButtonType.Primary" Icon="@IconType.Outline.Edit" OnClick="()=>OpenModifyNodeInfoDrawer(context)"></Button>
                            </SpaceItem>
                        </Space>
                    </ActionColumn>
                </ColumnDefinitions>

            </Table>
        </GridCol>
    </GridRow>
</GridContent>


@code{
    ITable _table;
    string? _keywords;

    bool _editFormVisible = false;
    bool _editFormSubmitting = false;
    bool _editFormConfirmLoading = false;

    enum NodeState
    {
        All,
        Online,
        Offline,
    }

    NodeState _nodeState;
    string _selectedAreaTag;

    IEnumerable<NodeInfoModel>? _dataSource = [];
    IEnumerable<NodeInfoModel>? _nodesDataSource = [];

    IEnumerable<StringEntry> _selectedIpAddressMappings = [];
    IEnumerable<StringEntry> _selectedProcessUsagesMappings = [];

    NodeSettings _nodeSettings = new NodeSettings();

    Form<NodeSettings> _editForm;

    bool _loading;

    bool nodeInfoDrawerVisible = false;

    string? _modifyErrorMsg;

    UpdateNodeProfileModel? _editingNodeInfoModel;


    void OpenModifyNodeInfoDrawer(NodeInfoModel nodeInfo)
    {
        this._editingNodeInfoModel = new UpdateNodeProfileModel()
            {
                NodeId = nodeInfo.Id,
                LabArea = nodeInfo.Profile.LabArea,
                LabName = nodeInfo.Profile.LabName,
                Remarks = nodeInfo.Profile.Remarks,
                TestInfo = nodeInfo.Profile.TestInfo,
                Usages = nodeInfo.Profile.Usages
            };
        this.nodeInfoDrawerVisible = true;
    }

    void CloseModifyNodeInfoDrawer()
    {
        this._modifyErrorMsg = null;
        this._editingNodeInfoModel = null;
        this.nodeInfoDrawerVisible = false;
    }

    async Task ShowNodeSettingsModalAsync()
    {
        _editFormVisible = true;
        await this.QueryNodeSettingsAsync();
    }



    async Task SubmitNodeInfoAsync()
    {
        try
        {
            var apiResponse = await this.ApiService.UpdateNodeProfileAsync(this._editingNodeInfoModel).ConfigureAwait(false);
            if (apiResponse.ErrorCode == 0)
            {
                this._editingNodeInfoModel = null;
                this.nodeInfoDrawerVisible = false;
                await this.QueryNodeListAsync();
            }
            else
            {
                this._modifyErrorMsg = apiResponse.Message;
            }

        }
        catch (Exception ex)
        {
            this._modifyErrorMsg = ex.Message;
        }
    }


    public List<TableFilter<string?>> areaNameFilters = [];

    private void HandleEditFormCancel(MouseEventArgs e)
    {
        this._editFormSubmitting = false;
        this._editFormVisible = false;
    }


    private void HandleEditFormOk(MouseEventArgs e)
    {
        this._editFormSubmitting = true;
        this._editForm.Submit();
    }

    private async Task QueryNodeSettingsAsync()
    {
        try
        {
            var apiResponse = await this.ApiService.QueryNodeSettingsAsync().ConfigureAwait(false);
            if (apiResponse.ErrorCode == 0)
            {
                this._nodeSettings = apiResponse.Result;
                if (this._nodeSettings.IpAddressMappings != null)
                {
                    areaNameFilters.Clear();
                    foreach (var item in this._nodeSettings.IpAddressMappings)
                    {
                        areaNameFilters.Add(new TableFilter<string?>()
                            {
                                Selected = item.Tag == "All",
                                Text = item.Name,
                                Value = item.Tag
                            });
                    }
                    this._selectedAreaTag = this._nodeSettings.IpAddressMappings.FirstOrDefault().Tag;
                    if (this._table!=null)
                    {
                        await InvokeAsync(this._table.ReloadData);
                    }
                }

            }
            else
            {
                await this._notice.Open(new NotificationConfig()
                    {
                        Message = "错误提示",
                        Description = apiResponse.Message,
                    });
            }
        }
        catch (Exception ex)
        {
            await this._notice.Open(new NotificationConfig()
                {
                    Message = "错误提示",
                    Description = ex.ToString(),
                });
        }

    }


    private async Task OnEditFormFinish(EditContext editContext)
    {
        try
        {
            var apiResponse = await this.ApiService.UpdateNodeSettingsAsync(this._nodeSettings).ConfigureAwait(false);
            if (apiResponse.ErrorCode == 0)
            {
                _editFormVisible = false;
                await _message.Info("更新节点设置成功");
            }
            else
            {
                await this._notice.Open(new NotificationConfig()
                    {
                        Message = "错误提示",
                        Description = apiResponse.Message,
                    });
            }
        }
        catch (Exception ex)
        {
            await this._notice.Open(new NotificationConfig()
                {
                    Message = "错误提示",
                    Description = ex.Message,
                });
        }
        finally
        {
            this._editFormSubmitting = false;
            this._editFormConfirmLoading = false;
        }
    }

    private void OnEditFormFinishFailed(EditContext editContext)
    {
        this._editFormSubmitting = false;
        this._editFormConfirmLoading = false;
    }

    private void OnNodeNameChanged(MouseEventArgs e)
    {

    }

    private void OnSelectedFactoryNameChanged(string value)
    {

    }

    private bool OnFilterFactoryName(string value, string name)
    {
        if (name == "All")
        {
            return true;
        }
        return name == value;
    }

    void OnRowClick(RowData<NodeInfoModel> row)
    {

    }

    private async Task OnRefreshClick()
    {
        this._loading = true;
        await this.QueryNodeListAsync().ConfigureAwait(false);
        this._loading = false;
    }

    async Task QueryNodeListAsync()
    {
        try
        {
            var apiResponse = await this.ApiService.QueryNodeListAsync(QueryParameters.All).ConfigureAwait(false);
            if (apiResponse.ErrorCode == 0)
            {
                this._nodesDataSource = apiResponse.Result ?? [];
                if (_table != null)
                {
                    await InvokeAsync(_table.ReloadData);
                }

            }
            else
            {
                await this._notice.Open(new NotificationConfig()
                    {
                        Message = "加载失败",
                        Description = apiResponse.Message,
                    });
            }
        }
        catch (Exception ex)
        {
            await this._notice.Open(new NotificationConfig()
                {
                    Message = "加载失败",
                    Description = ex.Message,
                });
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        this._loading = true;
        await this.QueryNodeListAsync();
        await this.QueryNodeSettingsAsync();
        this._loading = false;
    }

    private void OnNodeStatusChanged(NodeState nodeState)
    {
        this._table?.ReloadData();
    }

    private void OnTableChange(QueryModel<NodeInfoModel> query)
    {
        this._dataSource = query.ExecuteQuery(this._nodesDataSource.AsQueryable())
         .Where(FilterNodeInfo);
    }

    private bool IsNodeStatusMatched(NodeInfoModel nodeInfo)
    {
        switch (this._nodeState)
        {
            case NodeState.All:
                return true;
                break;
            case NodeState.Online:
                if (nodeInfo.Status == NodeStatus.Online)
                {
                    return true;
                }
                break;
            case NodeState.Offline:
                if (nodeInfo.Status == NodeStatus.Offline)
                {
                    return true;
                }
                break;
            default:
                break;
        }
        return false;
    }

    private bool IsNodeInfoFactoryTypeMatched(NodeInfoModel nodeInfo)
    {
        if (string.IsNullOrEmpty(this._selectedAreaTag) || this._selectedAreaTag == "All")
        {
            return true;
        }
        return this._selectedAreaTag == nodeInfo.Profile.FactoryName;
    }

    private bool IsKeywordsMatch(NodeInfoModel nodeInfo)
    {
        if (string.IsNullOrEmpty(this._keywords))
        {
            return true;
        }
        if (nodeInfo.Profile.FactoryName != null && nodeInfo.Profile.FactoryName.Contains(this._keywords))
        {
            return true;
        }
        if (nodeInfo.Name != null && nodeInfo.Name.Contains(this._keywords))
        {
            return true;
        }
        if (nodeInfo.Profile.IpAddress != null && nodeInfo.Profile.IpAddress.Contains(this._keywords))
        {
            return true;
        }
        if (nodeInfo.Profile.ClientVersion != null && nodeInfo.Profile.ClientVersion.Contains(this._keywords))
        {
            return true;
        }
        if (nodeInfo.Profile.Usages != null && nodeInfo.Profile.Usages.Contains(this._keywords))
        {
            return true;
        }
        if (nodeInfo.Profile.Remarks != null && nodeInfo.Profile.Remarks.Contains(this._keywords))
        {
            return true;
        }
        return false;
    }

    private bool FilterNodeInfo(NodeInfoModel nodeInfo)
    {
        return this.IsNodeInfoFactoryTypeMatched(nodeInfo) && this.IsNodeStatusMatched(nodeInfo) && this.IsKeywordsMatch(nodeInfo);
    }

    private void AddIpAddressMapping()
    {
        var entry = new StringEntry();
        this._nodeSettings.IpAddressMappings.Add(entry);
        entry.BeginEdit();
    }

    private void RemoveSelectedIpAddressMapping()
    {
        if (this._selectedIpAddressMappings == null)
        {
            return;
        }
        foreach (var item in this._selectedIpAddressMappings)
        {
            this._nodeSettings.IpAddressMappings.Remove(item);
        }
    }

    private void AddProcessUsageMapping()
    {
        var entry = new StringEntry();
        this._nodeSettings.ProcessUsagesMapping.Add(entry);
        entry.BeginEdit();
    }

    private void RemoveSelectedProcessUsageMapping()
    {
        if (this._selectedProcessUsagesMappings == null)
        {
            return;
        }
        foreach (var item in this._selectedProcessUsagesMappings)
        {
            this._nodeSettings.ProcessUsagesMapping.Remove(item);
        }
    }

}
