@using NodeService.WebServer.UI.Pages.TaskFlows.Designer.ViewModels
@using OneOf
<style  type="text/css">
    .ant-timeline{
        padding-top:10px;
    }

        .ant-timeline .ant-timeline-item{
            padding-bottom:20px;
        }
</style>

@if (TaskStage != null)
{
    <Timeline Pending="_pendding" Reverse="@ReverseGroups">
        @foreach (var taskGroup in _groups)
        {
            <TimelineItem>
                <TaskFlowGroupComponent TaskGroup="taskGroup" TaskGroupExecutionInstance="@FindTaskFlowGroupExecutionInstance(taskGroup)" OnRemoved="OnGroupRemoved" />
            </TimelineItem>
        }
    </Timeline>
}

@code {


    [Parameter]
    public TaskFlowStageTemplate TaskStage { get; set; }

    [Parameter]
    public TaskFlowStageExecutionInstance TaskStageExecutionInstance { get; set; }

    [Parameter]
    public EventCallback<TaskFlowGroupTemplate> OnGroupRemoved { get; set; }

    bool ReverseGroups
    {
        get
        {
            return TaskStage.ExecutionStatus >= TaskExecutionStatus.Triggered;
        }
    }

    IEnumerable<TaskFlowGroupTemplate> _groups
    {
        get
        {
            return !ReverseGroups ? TaskStage.TaskGroups : TaskStage.TaskGroups.Reverse<TaskFlowGroupTemplate>();
        }
    }

    OneOf<string, RenderFragment> _pendding
    {
        get
        {
            if (ReverseGroups)
            {
                RenderFragment renderFrangement =@<Template><Text>@TaskStage.ExecutionStatus</Text></Template> ;
                return renderFrangement;
            }
            else
            {
                return (string)null;
            }
        }
    }

    RenderFragment dotWaitTemplate =
    @<Template>
        <Icon Type="clock-circle" Style="font-size: 16px;" />
    </Template>;

    RenderFragment dotRunningTemplate =
    @<Template>
           <Icon Type="loading" Theme="outline" Style="font-size: 16px" Spin />;
    </Template>;

    RenderFragment dotErrorTemplate =
    @<Template>
        <Icon Type="warning" Theme="outline" />
    </Template>;

    RenderFragment dotStopTemplate =
    @<Template>
        <Icon Type="warning" Theme="outline" />
    </Template>
    ;

    private TaskFlowGroupExecutionInstance? FindTaskFlowGroupExecutionInstance(TaskFlowGroupTemplate taskFlowGroupTemplate)
    {
        return TaskStageExecutionInstance?.TaskGroups?.FirstOrDefault(x => x.TaskFlowGroupTemplateId == taskFlowGroupTemplate.Id);
    }
}
